<script>
  model = [
    {
      index: 0,
      question:
        'Which service gives a personalized view of the status of the AWS services that are part of your Cloud architecture so that you can quickly assess the impact on your business when AWS service(s) are experiencing issues?',
      options: [
        'AWS Health - Your Account Health Dashboard',
        'Amazon CloudWatch',
        'AWS Health - Service Health Dashboard',
        'Amazon Inspector',
      ],
      solutions: [0],
    },
    {
      index: 10,
      question: 'AWS Marketplace facilitates which of the following use-cases? (Select two)',
      options: [
        'Buy Amazon EC2 Standard Reserved Instances (RI)',
        'Sell Software as a Service (SaaS) solutions to AWS customers',
        'Purchase compliance documents from third-party vendors',
        'AWS customer can buy software that has been bundled into customized Amazon Machine Image (AMIs) by the AWS Marketplace sellers',
        'Raise request for purchasing AWS Direct Connect connection',
      ],
      solutions: [1, 3],
    },
    {
      index: 11,
      question: 'Which of the following AWS services offer block-level storage? (Select two)',
      options: [
        'Amazon Elastic File System (Amazon EFS)',
        'Amazon Simple Storage Service (Amazon S3)',
        'Amazon Elastic Container Service (Amazon ECS)',
        'Amazon Elastic Block Store (Amazon EBS)',
        'Instance Store',
      ],
      solutions: [3, 4],
    },
    {
      index: 4,
      question:
        'Which AWS service can help you analyze your infrastructure to identify unattached or underutilized Amazon EBS Elastic Volumes?',
      options: ['Amazon Inspector', 'Amazon CloudWatch', 'AWS Trusted Advisor', 'AWS Config'],
      solutions: [2],
    },
  ];

  answers = [[0], [1, 3], [3, 4], [2]];
</script>

<!--  -->

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>

<ul x-data="{ colors: model }">
  <template x-for="color in colors">
    <li x-text="color.question"></li>
  </template>
</ul>

<!--  -->

<style>
  body {
    font-family: sans-serif;
    font-size: 1.2rem;
  }

  body.show-correct .correct-answer {
    outline: lightgreen 4px solid;
  }
</style>

<!--  -->

<quizz-element></quizz-element>

<!--  -->

<script>
  const element = document.querySelector('quizz-element');

  window.onload = function () {
    fillAnswers();
    shuffleForm();
  };

  let correct = 0;
  let incorrectAnswers = [];

  function fillAnswers() {
    const query = '' + answers.flatMap((innerArray, i) => innerArray.map((value) => ` #opt-${i}-${value} [type="checkbox"]`));
    element.shadowRoot.querySelectorAll(query).forEach((input) => (input.checked = true));
  }

  function onChange(formNode, solution) {
    const formData = new FormData(formNode);
    const formValue = [...formData.keys()].map((key) => key);

    isCorrectAnswer = solution.every((el) => formValue.includes(String(el)));

    if (formValue.length == solution.length) {
      element.shadowRoot.querySelector('progress').value += 1;

      formNode.hidden = true;

      // correct answer
      if (isCorrectAnswer) correct++;
      else incorrectAnswers.push([...document.forms].indexOf(formNode) + 1);

      const nextForm = formNode?.nextElementSibling;

      // next question
      if (+formNode.dataset.formidx < model.length - 1) nextForm.hidden = false;
      // end of quizz
      else onFinish();
    }
  }

  function onFinish() {
    document.body.classList.add('show-correct');
    document.querySelectorAll('input[type="checkbox"]')?.forEach((el) => (el.disabled = true));

    document.querySelector('#correct-count')?.insertAdjacentText('afterend', ' ' + correct);
    document.querySelector('#incorrect-answers')?.insertAdjacentText('afterend', ' ' + incorrectAnswers);

    const rate = Math.floor((correct / model.length) * 100);
    document.querySelector('#rate')?.insertAdjacentText('afterend', ' ' + rate + '% ' + (rate >= 70 ? '(PASS)' : '(FAIL)'));
    document.querySelectorAll('[hidden]').forEach((n) => (n.hidden = false));
  }

  function shuffleForm() {
    document.querySelectorAll('.options-list').forEach((optsList) => {
      const optionNodes = [...optsList.children];
      optionNodes.sort(() => Math.random() - 0.5);
      optionNodes.forEach((optNode) => optsList.appendChild(optNode));
    });
  }

  customElements.define(
    'quizz-element',
    class QuizzElement extends HTMLElement {
      constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });

        const template = document.createElement('template');
        template.innerHTML = `


            <style>
              progress {
                display: block;
                width: auto;
              }

              #correct-count, #incorrect-answers, #rate {
                display: block;
              }

              form {
                margin-bottom: 2rem;
              }

              ul {
                list-style-type: none;
                padding: 0;

                & label{
                  line-height: 2.2rem
                }
              }
            </style>

            <button onclick="onFinish(); this.hidden = true;">SKIP QUIZZ</button>

            <div hidden>
              <b id="correct-count">Correct count:</b>
              <b id="incorrect-answers">Incorrect answers:</b>
              <b id="rate">Rate:</b>
              <hr>
            </div>

            <progress value="0" max="${model.length}"></progress>
            ${model.reduce(
              (acc, item, index) => `
            ${acc}
            <form data-formidx="${index}" onchange="onChange(this, ${JSON.stringify(item.solutions)})">
              <strong>Question ${index + 1}:</strong> ${item.question}
              <ul class="options-list">
                ${item.options.reduce(
                  (acc, option, i) =>
                    `
                ${acc}
                <li id="opt-${index}-${i}" class="${item.solutions.includes(i) ? 'correct-answer' : ''}">
                  <input type="checkbox" name="${i}" />
                  <label for="opt-${index}-${i}">${option}</label>
                </li>
              `,
                  ''
                )}
              </ul>
            </form>
          `,
              ''
            )}`;

        shadow.appendChild(template.content.cloneNode(true));
      }
    }
  );
</script>
