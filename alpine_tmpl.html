<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Quizz CLF-C02</title>

    <!-- Alpine Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>

    <!-- Alpine Core -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('model', () => ({
          questions,
          incorrects: [],
          selectedOpts: Alpine.$persist(Array.from({ length: this.questions.length }, () => [])),
          doneIndexes: Alpine.$persist([]),

          init() {
            this.$watch('incorrects', (value) => {});

            Alpine.effect(() => {
              this.incorrects = this.questions.reduce(
                (acc, sol, i) => (!sol.solutions.every((num, idx) => num === +this.selectedOpts[i][idx]) ? [...acc, i + 1] : acc),
                []
              );
            });
          },

          get correct() {
            return this.questions.length - this.incorrects.length;
          },

          get currentIndex() {
            return this.selectedOpts.findIndex((inner, idx) => inner.length < this.questions[idx].solutions.length);
          },

          get finished() {
            return this.currentIndex < 0;
          },

          get rate() {
            return Math.floor((this.correct / this.questions.length) * 100);
          },

          shuffleNodes(parentElement, tagName) {
            const childrenArray = [...parentElement.children].filter((el) => el.tagName == tagName);
            childrenArray.sort(() => Math.random() - 0.5);
            childrenArray.forEach((child) => parentElement.appendChild(child));
          },

          onRestartForm() {
            this.selectedOpts = Array.from({ length: this.questions.length }, () => []);
          },

          onFinish() {
            this.selectedOpts = this.questions.map((q) => q.solutions);
          },
        }));
      });
    </script>
  </head>

  <body class="font-sans text-darkslategrey">
    <form x-data="model" class="p-2">
      <button type="button" x-show="!finished" @click="onFinish()" class="bg-green-600 text-white py-1 px-2 rounded">
        SKIP QUIZZ
      </button>

      <button
        type="button"
        x-show="currentIndex || finished"
        @click="onRestartForm()"
        class="bg-green-600 text-white py-1 px-2 rounded"
      >
        RESTART QUIZZ
      </button>

      <progress
        value="0"
        :value="selectedOpts.length"
        :max="questions.length"
        class="w-full h-2 bg-green-200 [&::-webkit-progress-value]:bg-green-600 [&::-moz-progress-bar]:bg-green-600 [&::-webkit-progress-bar]:bg-green-200"
      ></progress>

      <template x-if="finished">
        <div class="my-4">
          <b>Correct count:</b> <span x-text="correct"></span><br />
          <b>Incorrect answers:</b> <span x-text="incorrects"></span><br />
          <b>Rate:</b>
          <span x-text="`${rate}% (${rate >= 70 ? 'PASS' : 'FAIL'})`"></span>
          <hr class="my-2" />
        </div>
      </template>

      <template x-for="(item, index) in questions" :key="index">
        <ul
          x-transition
          x-show="index == currentIndex || finished"
          x-init="$nextTick(() => shuffleNodes($el, 'LI'))"
          class="list-none p-2 mb-2 rounded-lg bg-green-50 ring-2 ring-green-600 ring-inset"
          :class="{ 'min-h-[calc(100lvh_-_5rem)]': !finished }"
        >
          <strong x-text="`Question ${index + 1}:`" class="block text-green-600"></strong>
          <span x-text="item.question"></span>

          <template x-for="(opt, optId) in item.options" :key="optId">
            <li :class="{ 'bg-green-200 ring-1 ring-green-600': item.solutions.includes(optId) && finished }" class="my-1 p-1">
              <input
                type="checkbox"
                :id="`opt-${index}-${optId}`"
                :value="optId"
                :disabled="finished"
                x-model="selectedOpts[index]"
                class="mr-2"
              />
              <label x-text="opt" :for="`opt-${index}-${optId}`" class="text-sm"></label>
            </li>
          </template>
        </ul>
      </template>
    </form>
  </body>
</html>
