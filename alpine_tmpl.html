<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Quizz CLF-C02</title>

    <!-- Alpine Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>

    <!-- Alpine Core -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      function fisherYatesShuffle(array) {
        let i = array.length;
        while (i--) {
          let j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]]; // Swap elements
        }
        return array;
      }

      function formatIncorrectLabel(incorrects) {
        if (incorrects.length === 0) return 'None';

        return incorrects
          .reduce((acc, next, idx) => (idx + 1 === incorrects.length ? `${acc} and ${next}` : `${acc}, ${next}`), '')
          .replace(/^(, | and )/, '');
      }

      document.addEventListener('alpine:init', () => {
        Alpine.data('model', () => ({
          questionList: questions,
          selectedOpts: Alpine.$persist(Array.from({ length: questions.length }, () => [])),
          reaIndexes: Alpine.$persist({}),
          result: {},

          get currentIndex() {
            return this.selectedOpts.findIndex((inner, idx) => inner.length < this.questionList[idx].solutions.length);
          },

          get finished() {
            return this.currentIndex < 0;
          },

          shuffleNodes(node) {
            const shuffled = fisherYatesShuffle([...node.children].filter((el) => el.tagName == 'LI'));
            shuffled.forEach((child) => node.appendChild(child));
          },

          onRestartQuizz() {
            this.selectedOpts = Array.from({ length: this.questionList.length }, () => []);
            this.questionList = this.questionList;
          },

          onSkipQuizz() {
            this.selectedOpts = this.questionList.map((q) => q.solutions);
          },

          getResults() {
            const [incorrects, currentIndexes] = this.questionList.reduce(
              (acc, next, idx) => {
                const isCorrect = this.selectedOpts[idx].every((e) => next.solutions.includes(+e));
                if (isCorrect) {
                  return [acc[0], [...acc[1], next.index]];
                }

                return [[...acc[0], idx], acc[1]];
              },
              [[], []]
            );

            const correct = this.questionList.length - incorrects.length;

            const rate = Math.floor((correct / this.questionList.length) * 100);

            this.result = {
              correctLabel: incorrects.length === 0 ? 'All correct!' : correct,
              incorrectsLable: formatIncorrectLabel(incorrects),
              rateLabel: `${rate}% (${rate >= 70 ? 'PASS üèÜ' : 'FAIL üíî'})`,
            };

            if (currentIndexes.length) {
              //  this.reaIndexes[new Date().toISOString()] = currentIndexes;
            }
          },
        }));
      });
    </script>
  </head>

  <body class="font-sans text-darkslategrey">
    <form x-data="model" class="p-2">
      <button type="button" x-show="!finished" @click="onSkipQuizz()" class="bg-green-600 text-white py-1 px-2 rounded">
        SKIP QUIZZ
      </button>

      <button
        type="button"
        x-show="currentIndex || finished"
        @click="onRestartQuizz()"
        class="bg-green-600 text-white py-1 px-2 rounded"
      >
        RESTART QUIZZ
      </button>

      <progress
        value="0"
        :value="currentIndex"
        :max="questionList.length"
        class="w-full h-2 bg-green-200 [&::-webkit-progress-value]:bg-green-600 [&::-moz-progress-bar]:bg-green-600 [&::-webkit-progress-bar]:bg-green-200"
      ></progress>

      <template x-if="finished">
        <div class="my-4" x-init="getResults()">
          <b>Correct count:</b> <span x-text="result.correctLabel"></span><br />
          <b>Incorrect answers:</b> <span x-text="result.incorrectsLable"></span><br />
          <b>Rate:</b> <span x-text="result.rateLabel"></span>
          <hr class="my-2" />
        </div>
      </template>

      <template x-for="(item, index) in questionList">
        <ul
          x-transition
          x-show="index == currentIndex || finished"
          x-init="$nextTick(() => shuffleNodes($el))"
          class="list-none p-2 mb-2 rounded-lg bg-green-50 ring-2 ring-green-600 ring-inset"
          :class="{ 'min-h-[calc(100dvh_-_5rem)]': !finished }"
        >
          <strong x-text="`Question ${index + 1}:`" class="block text-green-600"></strong>
          <span x-text="item.question"></span>

          <template x-for="(opt, optId) in item.options" :key="optId">
            <li :class="{ 'bg-green-200 ring-1 ring-green-600': item.solutions.includes(optId) && finished }" class="my-1 p-1">
              <input
                type="checkbox"
                :id="`opt-${index}-${optId}`"
                :value="optId"
                <
                :disabled="finished"
                x-model="selectedOpts[index]"
                class="mr-2"
              />
              <label x-text="opt" :for="`opt-${index}-${optId}`" class="text-sm"></label>
            </li>
          </template>
        </ul>
      </template>
    </form>
  </body>
</html>
